name: CD - Kubernetes Deploy

on:
  #push:
    branches:
      - main

jobs:
  deploy:
    runs-on: self-hosted

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up kubectl
      uses: azure/setup-kubectl@v3
      with:
        version: 'v1.27.0'

    - name: Apply Namespace
      run: |
        cd backend/k8s
        kubectl apply -f namespace.yaml
        echo "Namespace applied"
        kubectl get ns

    - name: Apply Persistent Volumes
      run: |
        cd backend/k8s
        kubectl apply -f pv/
        echo "PersistentVolumes applied"
        kubectl get pv

    - name: Apply StatefulSets
      run: |
        cd backend/k8s
        kubectl apply -f statefulset/
        echo "StatefulSets applied"
        kubectl get statefulsets -n ashapp
        kubectl get po -n ashapp

    - name: Apply Deployments
      run: |
        cd backend/k8s
        kubectl apply -f deployment/
        echo "Deployments applied"
        kubectl get deployments -n ashapp
        kubectl get po -n ashapp

    - name: Apply Services
      run: |
        cd backend/k8s
        kubectl apply -f services/
        echo "Services applied"
        kubectl get svc -n ashapp

    - name: Apply Ingress
      run: |
        cd backend/k8s
        kubectl apply -f ingress/
        echo "Ingress applied"
        kubectl get svc -n ingress-nginx
        kubectl get svc -n ashapp

    - name: Apply Network Policies
      run: |
        cd backend/k8s
        kubectl apply -f networkpolicies/
        echo "NetworkPolicies applied"
        kubectl get networkpolicy -n ashapp

    - name: Apply HPA
      run: |
        cd backend/k8s
        kubectl apply -f hpa/
        echo "HPA applied"
        kubectl get hpa -n ashapp

    - name: Apply RBAC
      run: |
        cd backend/k8s
        kubectl apply -f rbac/ --recursive
        echo "RBAC applied"
        kubectl get sa -n ashapp
        kubectl get role -n ashapp
        kubectl get rolebinding -n ashapp
